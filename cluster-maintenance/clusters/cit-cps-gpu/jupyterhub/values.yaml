# JupyterHub Configuration for GPU Cluster

# Proxy configuration
proxy:
  secretToken: "GENERATE_WITH_openssl_rand_-hex_32"
  service:
    type: ClusterIP

# Ingress configuration for external access
ingress:
  enabled: true
  hosts:
    - jupyterhub.cps.unileoben.ac.at
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/cluster-issuer: letsencrypt-prod
  tls:
    - secretName: jupyterhub-tls
      hosts:
        - jupyterhub.cps.unileoben.ac.at

# Hub configuration
hub:
  config:
    JupyterHub:
      admin_access: true
      authenticator_class: oauthenticator.generic.GenericOAuthenticator
      # Enable named servers for power users
      allow_named_servers: true
      named_server_limit_per_user: 3
      template_vars:
        org:
          name: "Montanuniversit√§t Leoben"
          logo_url: "https://www.unileoben.ac.at/fileadmin/shares/allgemeine_datenbank/logos/1-mul-logo/2-mul-logo-smoke-quer.svg"
          url: "https://www.unileoben.ac.at"
    GenericOAuthenticator:
      client_id: "vUhzKqEF0UxPtZNM8aRbA1ncaehhIAIA2x9r83FI"
      client_secret: "EbAzlZLERPQzmF2EQByhihKuUqp36u138fYERPptymppmJbWhquI4sHu9vchqtnMRqbAVnZS6nOA6G0FescWa13MOLdlegQB3yyZSqe5V32NtYsnfDOndyZHiqiL2Bj6"
      oauth_callback_url: "https://jupyterhub.cps.unileoben.ac.at/hub/oauth_callback"
      authorize_url: "https://auth.cps.unileoben.ac.at/application/o/authorize/"
      token_url: "https://auth.cps.unileoben.ac.at/application/o/token/"
      userdata_url: "https://auth.cps.unileoben.ac.at/application/o/userinfo/"
      login_service: "CPS Authentik"
      username_claim: "preferred_username"
      scope:
        - "openid"
        - "profile"
        - "email"
        - "groups"
      claim_groups_key: "groups"
      manage_groups: true
      # Allow all authenticated users - access control handled by Authentik
      allow_all: true
      admin_groups:
        - "jupyter_admin"

  db:
    pvc:
      storageClassName: nfs-client
      storage: 10Gi
  
  extraVolumes:
    - name: custom-templates
      configMap:
        name: jupyterhub-custom-templates
  extraVolumeMounts:
    - name: custom-templates
      mountPath: /etc/jupyterhub/custom

  # Install OAuthenticator package and jupyterhub-fancy-profiles
  extraConfig:
    00-install-packages: |
      import subprocess
      import sys
      try:
        import oauthenticator
      except ImportError:
        subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'oauthenticator'])
    
    01-custom-templates: |
      # Configure custom template path
      c.JupyterHub.template_paths = ['/etc/jupyterhub/custom']
      
      # Configure custom templates and info page
      import os
      from jupyterhub.handlers import BaseHandler
      from tornado import web
      
      class InfoHandler(BaseHandler):
          @web.authenticated
          async def get(self):
              user = await self.get_current_user()
              # Use JupyterHub's template environment instead of Tornado's direct render
              template_vars = {
                  'user': user,
                  'base_url': self.hub.base_url,
                  'org': getattr(self.settings.get('template_vars', {}), 'org', {}),
              }
              html = self.render_template("info.html", **template_vars)
              self.write(html)
      
      c.JupyterHub.extra_handlers = [
          (r"/info", InfoHandler),
      ]
      
    02-profiles: |
      # GPU profiles requiring access control
      GPU_PROFILE_SLUGS = {'gpu-pytorch-single', 'gpu-tensorflow-single', 'gpu-pytorch-dual', 'gpu-tensorflow-dual'}
      ALLOWED_GPU_GROUPS = {'cpsHPCAccess', 'jupyter_admin'}
      
      # Static HTML form with JavaScript-based dynamic filtering
      # Note: Callables (both sync and async) don't work with KubeSpawner's options_form
      # So we use static HTML with JavaScript that reads user info from the page
      c.Spawner.options_form = """
      <style>
        .profile-container {
          max-width: 900px;
          margin: 30px auto;
          padding: 0 15px;
        }
        .profile-header {
          text-align: center;
          margin-bottom: 30px;
        }
        .profile-header h2 {
          color: #2c3e50;
          font-weight: 300;
          margin-bottom: 10px;
        }
        .profile-header p {
          color: #7f8c8d;
          font-size: 14px;
        }
        .alert-gpu-restricted {
          background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
          border: 2px solid #ffc107;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 25px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .alert-gpu-restricted h4 {
          color: #856404;
          margin-top: 0;
          font-size: 18px;
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .alert-gpu-restricted p {
          color: #856404;
          margin-bottom: 0;
          line-height: 1.6;
        }
        .form-group-custom {
          margin-bottom: 25px;
        }
        .form-group-custom label {
          font-weight: 500;
          color: #2c3e50;
          margin-bottom: 10px;
          display: block;
          font-size: 16px;
        }
        .form-control-custom {
          width: 100%;
          padding: 12px 15px;
          font-size: 15px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          background: white;
          transition: all 0.3s ease;
        }
        .form-control-custom:focus {
          outline: none;
          border-color: #3498db;
          box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .form-control-custom option {
          padding: 10px;
        }
        .profile-info {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-top: 20px;
          font-size: 13px;
          color: #6c757d;
        }
        .gpu-badge {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
          margin-left: 8px;
        }
      </style>
      
      <div class="profile-container">
        <div class="profile-header">
          <h2>üöÄ Choose Your Computing Environment</h2>
          <p>Select the resources that match your computational needs</p>
        </div>
        
        <div id="gpu-access-notice" style="display: none;" class="alert-gpu-restricted">
          <h4>
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
            </svg>
            Limited Access
          </h4>
          <p>
            Your account currently has access to <strong>CPU-only profiles</strong>. 
            To request GPU access, please contact the CPS administrators and ask for membership 
            in the <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">cpsHPCAccess</code> group.
          </p>
        </div>
        
        <div class="form-group-custom">
          <label for="profile-select">Computing Profile</label>
          <select name="profile" id="profile-select" class="form-control-custom">
            <optgroup label="üíª CPU Profiles - Available to All Users">
              <option value="cpu-small">Small - 2 CPUs, 1GB RAM</option>
              <option value="cpu-medium" selected>Medium - 4 CPUs, 4GB RAM (Recommended)</option>
              <option value="cpu-large">Large - 8 CPUs, 8GB RAM</option>
              <option value="cpu-xlarge">X-Large - 16 CPUs, 16GB RAM</option>
            </optgroup>
            <optgroup id="gpu-optgroup" label="üöÄ GPU Profiles - Requires Authorization">
              <option value="gpu-pytorch-single">Single A100 GPU - PyTorch (8 CPUs, 32GB RAM)</option>
              <option value="gpu-tensorflow-single">Single A100 GPU - TensorFlow (8 CPUs, 32GB RAM)</option>
              <option value="gpu-pytorch-dual">Dual A100 GPUs - PyTorch (16 CPUs, 64GB RAM)</option>
              <option value="gpu-tensorflow-dual">Dual A100 GPUs - TensorFlow (16 CPUs, 64GB RAM)</option>
            </optgroup>
          </select>
        </div>
        
        <div class="profile-info">
          <strong>‚ÑπÔ∏è Note:</strong> All profiles include the JupyterLab interface with common data science packages.
          GPU profiles require approval from system administrators.
        </div>
      </div>
      
      <script>
      (function() {
        // Check user's GPU access by looking for admin indicator or group membership
        // JupyterHub templates expose user info via the page
        var allowedGPUGroups = ['cpsHPCAccess', 'jupyter_admin'];
        var hasGPUAccess = false;
        
        // Try to get user info from JupyterHub's page data
        try {
          // Check if user is admin (admins always have GPU access)
          var isAdmin = document.body.dataset.jupyterhubUser && 
                       JSON.parse(document.body.dataset.jupyterhubUser).admin;
          
          if (isAdmin) {
            hasGPUAccess = true;
          } else {
            // Check user's groups from the page data
            var userData = document.body.dataset.jupyterhubUser;
            if (userData) {
              var user = JSON.parse(userData);
              if (user.groups) {
                hasGPUAccess = user.groups.some(function(group) {
                  return allowedGPUGroups.indexOf(group) !== -1;
                });
              }
            }
          }
        } catch (e) {
          console.log('Could not parse user data, assuming no GPU access');
        }
        
        // Hide GPU profiles if user doesn't have access
        if (!hasGPUAccess) {
          var gpuOptgroup = document.getElementById('gpu-optgroup');
          if (gpuOptgroup) {
            gpuOptgroup.style.display = 'none';
          }
          
          var notice = document.getElementById('gpu-access-notice');
          if (notice) {
            notice.style.display = 'block';
          }
        }
        
        console.log('GPU Access Check:', hasGPUAccess);
      })();
      </script>
      """
      
      # Process form submission
      def options_from_form(formdata):
          """Extract selected profile from form data"""
          options = {}
          profile = formdata.get('profile', ['cpu-medium'])[0]
          options['profile'] = profile
          return options
      
      c.Spawner.options_from_form = options_from_form
      
      # Profile configurations (used by pre_spawn_hook to apply settings)
      PROFILE_CONFIGS = {
          'cpu-small': {
              'image': 'quay.io/jupyter/datascience-notebook:2025-11-06',
              'cpu_limit': 2.0,
              'cpu_guarantee': 0.5,
              'mem_limit': '1G',
              'mem_guarantee': '256M',
          },
          'cpu-medium': {
              'image': 'quay.io/jupyter/datascience-notebook:2025-11-06',
              'cpu_limit': 4.0,
              'cpu_guarantee': 1.0,
              'mem_limit': '4G',
              'mem_guarantee': '1G',
          },
          'cpu-large': {
              'image': 'quay.io/jupyter/datascience-notebook:2025-11-06',
              'cpu_limit': 8.0,
              'cpu_guarantee': 2.0,
              'mem_limit': '8G',
              'mem_guarantee': '2G',
          },
          'cpu-xlarge': {
              'image': 'quay.io/jupyter/datascience-notebook:2025-11-06',
              'cpu_limit': 16.0,
              'cpu_guarantee': 4.0,
              'mem_limit': '16G',
              'mem_guarantee': '4G',
          },
          'gpu-pytorch-single': {
              'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06',
              'cpu_limit': 8.0,
              'cpu_guarantee': 4.0,
              'mem_limit': '32G',
              'mem_guarantee': '16G',
              'extra_resource_limits': {'nvidia.com/gpu': '1'},
              'extra_resource_guarantees': {'nvidia.com/gpu': '1'},
              'node_selector': {'accelerator': 'nvidia'},
              'environment': {
                  'NVIDIA_VISIBLE_DEVICES': 'all',
                  'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
              }
          },
          'gpu-tensorflow-single': {
              'image': 'quay.io/jupyter/tensorflow-notebook:2025-11-06',
              'cpu_limit': 8.0,
              'cpu_guarantee': 4.0,
              'mem_limit': '32G',
              'mem_guarantee': '16G',
              'extra_resource_limits': {'nvidia.com/gpu': '1'},
              'extra_resource_guarantees': {'nvidia.com/gpu': '1'},
              'node_selector': {'accelerator': 'nvidia'},
              'environment': {
                  'NVIDIA_VISIBLE_DEVICES': 'all',
                  'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
              }
          },
          'gpu-pytorch-dual': {
              'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06',
              'cpu_limit': 16.0,
              'cpu_guarantee': 8.0,
              'mem_limit': '64G',
              'mem_guarantee': '32G',
              'extra_resource_limits': {'nvidia.com/gpu': '2'},
              'extra_resource_guarantees': {'nvidia.com/gpu': '2'},
              'node_selector': {'accelerator': 'nvidia'},
              'environment': {
                  'NVIDIA_VISIBLE_DEVICES': 'all',
                  'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
              }
          },
          'gpu-tensorflow-dual': {
              'image': 'quay.io/jupyter/tensorflow-notebook:2025-11-06',
              'cpu_limit': 16.0,
              'cpu_guarantee': 8.0,
              'mem_limit': '64G',
              'mem_guarantee': '32G',
              'extra_resource_limits': {'nvidia.com/gpu': '2'},
              'extra_resource_guarantees': {'nvidia.com/gpu': '2'},
              'node_selector': {'accelerator': 'nvidia'},
              'environment': {
                  'NVIDIA_VISIBLE_DEVICES': 'all',
                  'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
              }
          },
      }
      
      # Pre-spawn hook to apply profile settings and enforce access control
      async def apply_profile_settings(spawner):
          """
          Apply profile settings and enforce group-based access control.
          This approach mimics Docker Swarm's successful implementation.
          """
          # Get selected profile from user options
          profile_slug = spawner.user_options.get('profile', 'cpu-medium')
          
          spawner.log.info(f"User {spawner.user.name} selected profile: {profile_slug}")
          
          # Get user's groups
          group_names = {group.name for group in spawner.user.groups}
          
          # Check if it's a GPU profile
          if profile_slug in GPU_PROFILE_SLUGS:
              # Verify GPU access
              if not (group_names & ALLOWED_GPU_GROUPS):
                  spawner.log.warning(f"User {spawner.user.name} attempted GPU profile without permission")
                  raise Exception(f"‚ö†Ô∏è Access Denied: GPU profiles require membership in 'cpsHPCAccess' or 'jupyter_admin' group. Please contact CPS admins to request GPU access.")
              spawner.log.info(f"User {spawner.user.name} authorized for GPU profile (groups: {group_names & ALLOWED_GPU_GROUPS})")
          
          # Apply profile configuration
          if profile_slug in PROFILE_CONFIGS:
              config = PROFILE_CONFIGS[profile_slug]
              
              # Set image
              spawner.image = config['image']
              
              # Set resource limits
              spawner.cpu_limit = config['cpu_limit']
              spawner.cpu_guarantee = config['cpu_guarantee']
              spawner.mem_limit = config['mem_limit']
              spawner.mem_guarantee = config['mem_guarantee']
              
              # Set GPU resources if specified
              if 'extra_resource_limits' in config:
                  spawner.extra_resource_limits = config['extra_resource_limits']
              if 'extra_resource_guarantees' in config:
                  spawner.extra_resource_guarantees = config['extra_resource_guarantees']
              if 'node_selector' in config:
                  spawner.node_selector = config['node_selector']
              if 'environment' in config:
                  spawner.environment.update(config['environment'])
              
              spawner.log.info(f"Applied profile {profile_slug}: {config['cpu_limit']} CPU, {config['mem_limit']} RAM")
          else:
              spawner.log.warning(f"Unknown profile {profile_slug}, using default")
      
      c.KubeSpawner.pre_spawn_hook = apply_profile_settings
        
    gpu-config: |
      # Make GPUs available to users
      c.KubeSpawner.environment = {
          'NVIDIA_VISIBLE_DEVICES': 'all',
          'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
      }

# Singleuser notebook configuration
singleuser:
  # Default image with CUDA support
  image:
    name: quay.io/jupyter/tensorflow-notebook
    tag: "2025-11-06"
    pullPolicy: IfNotPresent
  
  # Storage for user notebooks
  storage:
    capacity: 10Gi
    dynamic:
      storageClass: nfs-client
    homeMountPath: /home/jovyan
  
  # Default resources (no GPU)
  cpu:
    limit: 2
    guarantee: 1
  memory:
    limit: 4G
    guarantee: 2G
  
  # Profile list now configured via jupyterhub-fancy-profiles in extraConfig

  # Allow users to sudo (for package installation)
  uid: 1000
  fsGid: 100
  extraEnv:
    GRANT_SUDO: "yes"
    NOTEBOOK_ARGS: "--allow-root"

# Scheduling
scheduling:
  userScheduler:
    enabled: true
  podPriority:
    enabled: true
  userPlaceholder:
    enabled: false

# Culling (shut down idle notebooks)
cull:
  enabled: true
  timeout: 3600  # 1 hour
  every: 600     # Check every 10 minutes
  maxAge: 0      # Don't cull based on age
