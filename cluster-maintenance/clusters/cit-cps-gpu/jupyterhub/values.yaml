# =============================================================================
# JupyterHub Configuration (schema-compliant)
# - Fast $HOME on SSD (emptyDir)
# - Per-user Persist on NFS via subPathExpr (single shared PVC)
# - Shared NFS at /home/jovyan/Shared (single shared PVC)
# - PostgreSQL Hub DB
# - NGINX Ingress, long websocket timeouts
# - High-user-count tweaks
# =============================================================================

proxy:
  service:
    type: ClusterIP
  chp:
    extraEnv:
      CONFIGPROXY_NUM_WORKERS: "6"

ingress:
  enabled: true
  ingressClassName: nginx
  hosts: [jupyterhub.cps.unileoben.ac.at]
  annotations:
    kubernetes.io/ingress.class: nginx
    # WebSockets / long sessions / uploads
    nginx.ingress.kubernetes.io/enable-websocket: "true"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-body-size: "2g"
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "16"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "32k"
    nginx.ingress.kubernetes.io/proxy-next-upstream: "error timeout http_502 http_503 http_504"
    nginx.ingress.kubernetes.io/proxy-next-upstream-tries: "3"
    # sticky (optional if you ever scale proxy-public)
    # nginx.ingress.kubernetes.io/affinity: "cookie"
    # nginx.ingress.kubernetes.io/session-cookie-name: "hubroute"
  tls:
    - secretName: jupyterhub-tls
      hosts: [jupyterhub.cps.unileoben.ac.at]

hub:
  config:
    JupyterHub:
      admin_access: true
      authenticator_class: oauthenticator.generic.GenericOAuthenticator
      allow_named_servers: true
      named_server_limit_per_user: 3
      template_vars:
        org:
          name: "MontanuniversitÃ¤t Leoben"
          logo_url: "https://www.unileoben.ac.at/fileadmin/shares/allgemeine_datenbank/logos/1-mul-logo/2-mul-logo-smoke-quer.svg"
          url: "https://www.unileoben.ac.at"

    GenericOAuthenticator:
      client_id: "vUhzKqEF0UxPtZNM8aRbA1ncaehhIAIA2x9r83FI"
      client_secret: "EbAzlZLERPQzmF2EQByhihKuUqp36u138fYERPptymppmJbWhquI4sHu9vchqtnMRqbAVnZS6nOA6G0FescWa13MOLdlegQB3yyZSqe5V32NtYsnfDOndyZHiqiL2Bj6"
      oauth_callback_url: "https://jupyterhub.cps.unileoben.ac.at/hub/oauth_callback"
      authorize_url: "https://auth.cps.unileoben.ac.at/application/o/authorize/"
      token_url: "https://auth.cps.unileoben.ac.at/application/o/token/"
      userdata_url: "https://auth.cps.unileoben.ac.at/application/o/userinfo/"
      login_service: "CPS Authentik"
      username_claim: "preferred_username"
      scope: ["openid","profile","email","groups"]
      claim_groups_key: "groups"
      manage_groups: true
      admin_groups: ["jupyter_admin"]

  # PostgreSQL (no sqlite)
  db:
    type: postgres
    url: postgresql://jhub:jhub-secure-db-password-2025@postgresql.jupyterhub.svc.cluster.local:5432/jhub

  # Hub sizing for 200+ concurrent users
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2"
      memory: "4Gi"
  extraEnv:
    JUPYTERHUB_API_PAGE_SIZE: "200"
    JUPYTERHUB_ACTIVE_SERVER_LIMIT: "0"

  extraVolumes:
    - name: custom-templates
      configMap:
        name: jupyterhub-custom-templates
  extraVolumeMounts:
    - name: custom-templates
      mountPath: /etc/jupyterhub/custom

  extraConfig:
    00-install-oauthenticator: |
      import subprocess, sys
      try:
          import oauthenticator  # noqa
      except ImportError:
          subprocess.check_call([sys.executable, "-m", "pip", "install", "oauthenticator"])

    01-info-endpoint: |
      c.JupyterHub.template_paths = ['/etc/jupyterhub/custom']
      from jupyterhub.handlers import BaseHandler
      from tornado import web
      class InfoHandler(BaseHandler):
          @web.authenticated
          async def get(self):
              user = await self.get_current_user()
              jinja_env = self.settings.get('jinja2_env', None)
              template_vars = jinja_env.globals.get('template_vars', {}) if jinja_env else {}
              org = template_vars.get('org', {})
              html = self.render_template("info.html", user=user, base_url=self.base_url, org=org)
              self.write(html)
      c.JupyterHub.extra_handlers = [(r"/info", InfoHandler)]

singleuser:
  image:
    name: quay.io/jupyter/datascience-notebook
    tag: "2025-11-06"
    pullPolicy: IfNotPresent

  # If you use GPU profiles, keep the runtime here so schema stays valid
  extraPodConfig:
    runtimeClassName: nvidia

  # ---------- STORAGE ----------
  storage:
    # Make $HOME fast by default (emptyDir on node SSD)
    type: none
    extraVolumes:
      # Fast ephemeral home
      - name: fast-home
        emptyDir: {}
      # Shared RWX NFS (PVC must exist; dynamic via nfs-subdir-provisioner)
      - name: shared-rwx
        persistentVolumeClaim:
          claimName: jhub-shared-rwx
      # Per-user persistent NFS via subPathExpr on a single RWX PVC
      - name: userdir-rwx
        persistentVolumeClaim:
          claimName: jhub-userdir-rwx

    extraVolumeMounts:
      # $HOME on SSD
      - name: fast-home
        mountPath: /home/jovyan
      # Shared datasets/team space
      - name: shared-rwx
        mountPath: /home/jovyan/Shared
        readOnly: false
      # Durable per-user dir (each user mapped to a subdir)
      - name: userdir-rwx
        mountPath: /home/jovyan/Persist
        readOnly: false
        subPathExpr: "users/$(JUPYTERHUB_USER)"

  # Group-writable NFS
  uid: 1000
  fsGid: 100

  # Fast-by-default: open Lab at $HOME and keep caches local
  extraEnv:
    GRANT_SUDO: "yes"
    NOTEBOOK_ARGS: "--allow-root"
    JUPYTERHUB_SINGLEUSER_APP: "jupyter_server.serverapp.ServerApp"
    JUPYTERHUB_SINGLEUSER_ARGS: >-
      --ServerApp.default_url=/lab/tree
      --ServerApp.terminado_settings="{\"shell_command\":[\"/bin/bash\"]}"
    XDG_CACHE_HOME: /home/jovyan/.cache
    PIP_CACHE_DIR: /home/jovyan/.cache/pip
    HF_HOME: /home/jovyan/.cache/huggingface
    TRANSFORMERS_CACHE: /home/jovyan/.cache/huggingface/transformers
    TORCH_HOME: /home/jovyan/.cache/torch
    NUMBA_CACHE_DIR: /home/jovyan/.cache/numba

  # Cloud metadata block without sidecar (PodSecurity-friendly)
  cloudMetadata:
    blockWithIptables: true

  # Lifecycle hooks (schema key is lifecycleHooks, not extraContainerConfig)
  lifecycleHooks:
    postStart:
      exec:
        command:
          - /bin/sh
          - -c
          - |
            set -eu
            echo "âš¡ Fast workspace (ephemeral):   /home/jovyan" > /home/jovyan/README.txt
            echo "ðŸ’¾ Persistent storage (NFS):     /home/jovyan/Persist" >> /home/jovyan/README.txt
            echo "ðŸ‘¥ Shared storage (NFS, RWX):    /home/jovyan/Shared"  >> /home/jovyan/README.txt
            [ -e /home/jovyan/Projects ] || mkdir -p /home/jovyan/Projects
            [ -e /home/jovyan/Data ] || mkdir -p /home/jovyan/Data
            [ -e /home/jovyan/Save ] || ln -s /home/jovyan/Persist /home/jovyan/Save
    preStop:
      exec:
        command:
          - /bin/sh
          - -c
          - |
            # Best-effort sync of common work files on graceful stop
            set -eu
            dst="/home/jovyan/Persist/last_session/$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$dst" || true
            rsync -a --prune-empty-dirs \
              --include='*/' \
              --include='*.ipynb' --include='*.py' --include='*.md' \
              --exclude='.cache' --exclude='**/.git' --exclude='**/__pycache__' \
              /home/jovyan/ "$dst" || true

  # Baseline CPU/RAM for default spawns (profiles can override)
  cpu:
    limit: 2
    guarantee: 1
  memory:
    limit: 4G
    guarantee: 2G

# -----------------------------------------------------------------------------
# Scheduling / scale knobs
# -----------------------------------------------------------------------------
scheduling:
  userScheduler:
    enabled: true
  podPriority:
    enabled: true
  userPlaceholder:
    enabled: false

prePuller:
  continuous:
    enabled: true

cull:
  enabled: true
  timeout: 3600
  every: 600
  maxAge: 0
  users: false
  adminUsers: true
  removeNamedServers: false
  concurrency: 20
