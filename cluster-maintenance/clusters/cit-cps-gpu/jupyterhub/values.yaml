# JupyterHub Configuration for GPU Cluster

# Proxy configuration
proxy:
  secretToken: "GENERATE_WITH_openssl_rand_-hex_32"
  service:
    type: ClusterIP

# Ingress configuration for external access
ingress:
  enabled: true
  hosts:
    - jupyterhub.cps.unileoben.ac.at
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/cluster-issuer: letsencrypt-prod
  tls:
    - secretName: jupyterhub-tls
      hosts:
        - jupyterhub.cps.unileoben.ac.at

# Hub configuration
hub:
  config:
    JupyterHub:
      admin_access: true
      authenticator_class: oauthenticator.generic.GenericOAuthenticator
      template_vars:
        org:
          name: "Montanuniversit√§t Leoben"
          logo_url: "https://www.unileoben.ac.at/fileadmin/shares/allgemeine_datenbank/logos/1-mul-logo/2-mul-logo-smoke-quer.svg"
          url: "https://www.unileoben.ac.at"
    GenericOAuthenticator:
      client_id: "vUhzKqEF0UxPtZNM8aRbA1ncaehhIAIA2x9r83FI"
      client_secret: "EbAzlZLERPQzmF2EQByhihKuUqp36u138fYERPptymppmJbWhquI4sHu9vchqtnMRqbAVnZS6nOA6G0FescWa13MOLdlegQB3yyZSqe5V32NtYsnfDOndyZHiqiL2Bj6"
      oauth_callback_url: "https://jupyterhub.cps.unileoben.ac.at/hub/oauth_callback"
      authorize_url: "https://auth.cps.unileoben.ac.at/application/o/authorize/"
      token_url: "https://auth.cps.unileoben.ac.at/application/o/token/"
      userdata_url: "https://auth.cps.unileoben.ac.at/application/o/userinfo/"
      login_service: "CPS Authentik"
      username_claim: "preferred_username"
      scope:
        - "openid"
        - "profile"
        - "email"
        - "groups"
      claim_groups_key: "groups"
      manage_groups: true
      # Allow all authenticated users - access control handled by Authentik
      allow_all: true
      admin_groups:
        - "jupyter_admin"

  db:
    pvc:
      storageClassName: nfs-client
      storage: 10Gi
  
  extraVolumes:
    - name: custom-templates
      configMap:
        name: jupyterhub-custom-templates
  extraVolumeMounts:
    - name: custom-templates
      mountPath: /etc/jupyterhub/custom

  # Install OAuthenticator package and jupyterhub-fancy-profiles
  extraConfig:
    00-install-packages: |
      import subprocess
      import sys
      try:
        import oauthenticator
      except ImportError:
        subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'oauthenticator'])
    
    01-custom-templates: |
      # Configure custom template path
      c.JupyterHub.template_paths = ['/etc/jupyterhub/custom']
      
      # Configure custom templates and info page
      import os
      from jupyterhub.handlers import BaseHandler
      from tornado import web
      
      class InfoHandler(BaseHandler):
          @web.authenticated
          async def get(self):
              user = await self.get_current_user()
              # Use JupyterHub's template environment instead of Tornado's direct render
              template_vars = {
                  'user': user,
                  'base_url': self.hub.base_url,
                  'org': getattr(self.settings.get('template_vars', {}), 'org', {}),
              }
              html = self.render_template("info.html", **template_vars)
              self.write(html)
      
      c.JupyterHub.extra_handlers = [
          (r"/info", InfoHandler),
      ]
      
    02-profiles: |
      # Dynamic profile configuration based on user groups
      def dynamic_profile_list(spawner):
          """
          Generate profile list dynamically based on user's group membership.
          Users in 'cpsHPCAccess' get full GPU access and custom image options.
          Other users get simple CPU-only profile.
          """
          user = spawner.user
          user_groups = set(group.name for group in user.groups)
          
          # Check if user has HPC access
          has_hpc_access = 'cpsHPCAccess' in user_groups
          
          if has_hpc_access:
              # Advanced users get full GPU profiles with custom options
              return [
                  {
                      'display_name': 'üíª CPU Only (Basic)',
                      'description': 'Lightweight CPU-only environment (2 cores, 4GB RAM)',
                      'default': True,
                      'kubespawner_override': {
                          'cpu_limit': 2,
                          'cpu_guarantee': 1,
                          'mem_limit': '4G',
                          'mem_guarantee': '2G',
                          'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06'
                      }
                  },
                  {
                      'display_name': 'üöÄ Single A100 GPU',
                      'description': 'High-performance with 1 NVIDIA A100 GPU (8 cores, 32GB RAM)',
                      'kubespawner_override': {
                          'cpu_limit': 8,
                          'cpu_guarantee': 4,
                          'mem_limit': '32G',
                          'mem_guarantee': '16G',
                          'extra_resource_limits': {'nvidia.com/gpu': '1'},
                          'extra_resource_guarantees': {'nvidia.com/gpu': '1'},
                          'node_selector': {'accelerator': 'nvidia'},
                          'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06'
                      }
                  },
                  {
                      'display_name': 'üî• Dual A100 GPUs',
                      'description': 'Maximum performance with 2 NVIDIA A100 GPUs (16 cores, 64GB RAM)',
                      'kubespawner_override': {
                          'cpu_limit': 16,
                          'cpu_guarantee': 8,
                          'mem_limit': '64G',
                          'mem_guarantee': '32G',
                          'extra_resource_limits': {'nvidia.com/gpu': '2'},
                          'extra_resource_guarantees': {'nvidia.com/gpu': '2'},
                          'node_selector': {'accelerator': 'nvidia'},
                          'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06'
                      }
                  },
                  {
                      'display_name': '‚öôÔ∏è Custom Configuration',
                      'description': 'Customize your resources and container image (Max: 2 GPUs, 128GB RAM)',
                      'profile_options': {
                          'image': {
                              'display_name': 'Container Image',
                              'unlisted_choice': {
                                  'enabled': True,
                                  'display_name': 'Custom image',
                                  'validation_regex': '^.+:.+$',
                                  'validation_message': 'Must be a valid image:tag format',
                                  'kubespawner_override': {'image': '{value}'}
                              },
                              'choices': {
                                  'pytorch': {
                                      'display_name': 'PyTorch (Latest)',
                                      'kubespawner_override': {'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06'}
                                  },
                                  'tensorflow': {
                                      'display_name': 'TensorFlow (Latest)',
                                      'kubespawner_override': {'image': 'quay.io/jupyter/tensorflow-notebook:2025-11-06'}
                                  },
                                  'datascience': {
                                      'display_name': 'Data Science Stack',
                                      'kubespawner_override': {'image': 'quay.io/jupyter/datascience-notebook:2025-11-06'}
                                  }
                              }
                          },
                          'gpu_count': {
                              'display_name': 'Number of GPUs',
                              'choices': {
                                  '0': {
                                      'display_name': 'No GPU',
                                      'kubespawner_override': {}
                                  },
                                  '1': {
                                      'display_name': '1 GPU',
                                      'default': True,
                                      'kubespawner_override': {
                                          'extra_resource_limits': {'nvidia.com/gpu': '1'},
                                          'extra_resource_guarantees': {'nvidia.com/gpu': '1'},
                                          'node_selector': {'accelerator': 'nvidia'}
                                      }
                                  },
                                  '2': {
                                      'display_name': '2 GPUs',
                                      'kubespawner_override': {
                                          'extra_resource_limits': {'nvidia.com/gpu': '2'},
                                          'extra_resource_guarantees': {'nvidia.com/gpu': '2'},
                                          'node_selector': {'accelerator': 'nvidia'}
                                      }
                                  }
                              }
                          },
                          'cpu_cores': {
                              'display_name': 'CPU Cores',
                              'choices': {
                                  '2': {
                                      'display_name': '2 cores',
                                      'kubespawner_override': {'cpu_limit': 2, 'cpu_guarantee': 1}
                                  },
                                  '4': {
                                      'display_name': '4 cores',
                                      'kubespawner_override': {'cpu_limit': 4, 'cpu_guarantee': 2}
                                  },
                                  '8': {
                                      'display_name': '8 cores',
                                      'default': True,
                                      'kubespawner_override': {'cpu_limit': 8, 'cpu_guarantee': 4}
                                  },
                                  '16': {
                                      'display_name': '16 cores',
                                      'kubespawner_override': {'cpu_limit': 16, 'cpu_guarantee': 8}
                                  }
                              }
                          },
                          'memory': {
                              'display_name': 'Memory (RAM)',
                              'choices': {
                                  '4': {
                                      'display_name': '4 GB',
                                      'kubespawner_override': {'mem_limit': '4G', 'mem_guarantee': '2G'}
                                  },
                                  '8': {
                                      'display_name': '8 GB',
                                      'kubespawner_override': {'mem_limit': '8G', 'mem_guarantee': '4G'}
                                  },
                                  '16': {
                                      'display_name': '16 GB',
                                      'kubespawner_override': {'mem_limit': '16G', 'mem_guarantee': '8G'}
                                  },
                                  '32': {
                                      'display_name': '32 GB',
                                      'default': True,
                                      'kubespawner_override': {'mem_limit': '32G', 'mem_guarantee': '16G'}
                                  },
                                  '64': {
                                      'display_name': '64 GB',
                                      'kubespawner_override': {'mem_limit': '64G', 'mem_guarantee': '32G'}
                                  },
                                  '128': {
                                      'display_name': '128 GB',
                                      'kubespawner_override': {'mem_limit': '128G', 'mem_guarantee': '64G'}
                                  }
                              }
                          }
                      }
                  }
              ]
          else:
              # Regular users get only CPU profile
              return [
                  {
                      'display_name': 'üíª Standard Notebook Environment',
                      'description': 'CPU-only notebook server (2 cores, 4GB RAM) - suitable for general data analysis and Python programming. For GPU access, please contact your administrator.',
                      'default': True,
                      'kubespawner_override': {
                          'cpu_limit': 2,
                          'cpu_guarantee': 1,
                          'mem_limit': '4G',
                          'mem_guarantee': '2G',
                          'image': 'quay.io/jupyter/pytorch-notebook:2025-11-06'
                      }
                  }
              ]
      
      # Set the dynamic profile list
      c.KubeSpawner.profile_list = dynamic_profile_list
      
      # Always show options form (don't skip it)
      c.Spawner.options_from_form = lambda form_data: form_data
        
    gpu-config: |
      # Make GPUs available to users
      c.KubeSpawner.environment = {
          'NVIDIA_VISIBLE_DEVICES': 'all',
          'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
      }

# Singleuser notebook configuration
singleuser:
  # Default image with CUDA support
  image:
    name: quay.io/jupyter/tensorflow-notebook
    tag: "2025-11-06"
    pullPolicy: IfNotPresent
  
  # Storage for user notebooks
  storage:
    capacity: 10Gi
    dynamic:
      storageClass: nfs-client
    homeMountPath: /home/jovyan
  
  # Default resources (no GPU)
  cpu:
    limit: 2
    guarantee: 1
  memory:
    limit: 4G
    guarantee: 2G
  
  # Profile list now configured via jupyterhub-fancy-profiles in extraConfig

  # Allow users to sudo (for package installation)
  uid: 1000
  fsGid: 100
  extraEnv:
    GRANT_SUDO: "yes"
    NOTEBOOK_ARGS: "--allow-root"

# Scheduling
scheduling:
  userScheduler:
    enabled: true
  podPriority:
    enabled: true
  userPlaceholder:
    enabled: false

# Culling (shut down idle notebooks)
cull:
  enabled: true
  timeout: 3600  # 1 hour
  every: 600     # Check every 10 minutes
  maxAge: 0      # Don't cull based on age
