# JupyterHub Configuration for GPU Cluster

# Proxy configuration
proxy:
  secretToken: "GENERATE_WITH_openssl_rand_-hex_32"
  service:
    type: ClusterIP

# Ingress configuration for external access
ingress:
  enabled: true
  ingressClassName: "traefik"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    traefik.ingress.kubernetes.io/router.middlewares: "default-redirect-https@kubernetescrd"
  hosts:
    - jupyterhub.cps.unileoben.ac.at
  pathType: Prefix
  tls:
    - secretName: jupyterhub-tls
      hosts:
        - jupyterhub.cps.unileoben.ac.at

# Hub configuration
hub:
  config:
    JupyterHub:
      admin_access: true
      authenticator_class: oauthenticator.generic.GenericOAuthenticator
    GenericOAuthenticator:
      client_id: "vUhzKqEF0UxPtZNM8aRbA1ncaehhIAIA2x9r83FI"
      client_secret: "EbAzlZLERPQzmF2EQByhihKuUqp36u138fYERPptymppmJbWhquI4sHu9vchqtnMRqbAVnZS6nOA6G0FescWa13MOLdlegQB3yyZSqe5V32NtYsnfDOndyZHiqiL2Bj6"
      oauth_callback_url: "https://jupyterhub.cps.unileoben.ac.at/hub/oauth_callback"
      authorize_url: "https://auth.cps.unileoben.ac.at/application/o/authorize/"
      token_url: "https://auth.cps.unileoben.ac.at/application/o/token/"
      userdata_url: "https://auth.cps.unileoben.ac.at/application/o/userinfo/"
      login_service: "CPS Authentik"
      username_claim: "preferred_username"
      scope:
        - "openid"
        - "profile"
        - "email"
      claim_groups_key: "groups"
      manage_groups: true
      allowed_groups:
        - "cps-users"
      admin_groups:
        - "cps-admins"
  
  db:
    pvc:
      storageClassName: nfs-client
      storage: 10Gi

  # Install OAuthenticator package
  extraConfig:
    00-install-oauthenticator: |
      import subprocess
      import sys
      try:
        import oauthenticator
      except ImportError:
        subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'oauthenticator'])
        
    gpu-config: |
      # Make GPUs available to users
      c.KubeSpawner.environment = {
          'NVIDIA_VISIBLE_DEVICES': 'all',
          'NVIDIA_DRIVER_CAPABILITIES': 'compute,utility'
      }

# Singleuser notebook configuration
singleuser:
  # Default image with CUDA support
  image:
    name: quay.io/jupyter/tensorflow-notebook
    tag: "2025-11-06"
    pullPolicy: IfNotPresent
  
  # Storage for user notebooks
  storage:
    capacity: 10Gi
    dynamic:
      storageClass: nfs-client
    homeMountPath: /home/jovyan
  
  # Default resources (no GPU)
  cpu:
    limit: 2
    guarantee: 1
  memory:
    limit: 4G
    guarantee: 2G
  
  # Profile list for GPU selection
  profileList:
    - display_name: "CPU Only (2 cores, 4GB RAM)"
      description: "Standard notebook without GPU"
      default: true
      kubespawner_override:
        cpu_limit: 2
        cpu_guarantee: 1
        mem_limit: "4G"
        mem_guarantee: "2G"
    
    - display_name: "Single A100 GPU (8 cores, 32GB RAM)"
      description: "Notebook with 1x NVIDIA A100 GPU"
      kubespawner_override:
        cpu_limit: 8
        cpu_guarantee: 4
        mem_limit: "32G"
        mem_guarantee: "16G"
        extra_resource_limits:
          nvidia.com/gpu: "1"
        extra_resource_guarantees:
          nvidia.com/gpu: "1"
        node_selector:
          accelerator: nvidia
        image: quay.io/jupyter/pytorch-notebook:2025-11-06
    
    - display_name: "Dual A100 GPUs (16 cores, 64GB RAM)"
      description: "Notebook with 2x NVIDIA A100 GPUs"
      kubespawner_override:
        cpu_limit: 16
        cpu_guarantee: 8
        mem_limit: "64G"
        mem_guarantee: "32G"
        extra_resource_limits:
          nvidia.com/gpu: "2"
        extra_resource_guarantees:
          nvidia.com/gpu: "2"
        node_selector:
          accelerator: nvidia
        image: quay.io/jupyter/pytorch-notebook:2025-11-06
    
    - display_name: "Research (32 cores, 128GB RAM, 4 GPUs)"
      description: "Large instance for intensive workloads"
      kubespawner_override:
        cpu_limit: 32
        cpu_guarantee: 16
        mem_limit: "128G"
        mem_guarantee: "64G"
        extra_resource_limits:
          nvidia.com/gpu: "4"
        extra_resource_guarantees:
          nvidia.com/gpu: "4"
        node_selector:
          accelerator: nvidia
        image: quay.io/jupyter/pytorch-notebook:2025-11-06

  # Allow users to sudo (for package installation)
  uid: 1000
  fsGid: 100
  extraEnv:
    GRANT_SUDO: "yes"
    NOTEBOOK_ARGS: "--allow-root"

# Scheduling
scheduling:
  userScheduler:
    enabled: true
  podPriority:
    enabled: true
  userPlaceholder:
    enabled: false

# Culling (shut down idle notebooks)
cull:
  enabled: true
  timeout: 3600  # 1 hour
  every: 600     # Check every 10 minutes
  maxAge: 0      # Don't cull based on age
