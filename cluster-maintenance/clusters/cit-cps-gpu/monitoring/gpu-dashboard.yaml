apiVersion: v1
kind: ConfigMap
metadata:
  name: nvidia-gpu-monitoring-dashboard
  namespace: cattle-dashboards
  labels:
    grafana_dashboard: "1"
    app: "rancher-monitoring"
data:
  nvidia-gpu-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "NVIDIA GPU Cluster Monitoring",
        "tags": ["nvidia", "gpu", "kubernetes"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "GPU Utilization",
            "type": "stat",
            "targets": [
              {
                "expr": "DCGM_FI_DEV_GPU_UTIL",
                "legendFormat": "GPU {{gpu}} - {{exported_instance}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "options": {
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"],
                "fields": ""
              },
              "orientation": "auto",
              "textMode": "auto",
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto"
            },
            "pluginVersion": "8.5.0",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 70},
                    {"color": "red", "value": 90}
                  ]
                },
                "unit": "percent",
                "min": 0,
                "max": 100
              }
            }
          },
          {
            "id": 2,
            "title": "GPU Memory Usage",
            "type": "stat",
            "targets": [
              {
                "expr": "DCGM_FI_DEV_FB_USED / (DCGM_FI_DEV_FB_USED + DCGM_FI_DEV_FB_FREE) * 100",
                "legendFormat": "GPU {{gpu}} Memory - {{exported_instance}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "options": {
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"],
                "fields": ""
              },
              "orientation": "auto",
              "textMode": "auto",
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto"
            },
            "pluginVersion": "8.5.0",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 80},
                    {"color": "red", "value": 95}
                  ]
                },
                "unit": "percent",
                "min": 0,
                "max": 100
              }
            }
          },
          {
            "id": 3,
            "title": "GPU Temperature",
            "type": "timeseries",
            "targets": [
              {
                "expr": "DCGM_FI_DEV_GPU_TEMP",
                "legendFormat": "GPU {{gpu}} - {{exported_instance}}"
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8},
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 10,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "never",
                  "pointSize": 5,
                  "stacking": {"mode": "none", "group": "A"},
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {"type": "linear"},
                  "axisCenteredZero": false,
                  "hideFrom": {"legend": false, "tooltip": false, "vis": false},
                  "thresholdsStyle": {"mode": "off"}
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 75},
                    {"color": "red", "value": 85}
                  ]
                },
                "unit": "celsius"
              }
            },
            "options": {
              "tooltip": {"mode": "single", "sort": "none"},
              "legend": {"displayMode": "table", "placement": "right", "calcs": ["last", "max"]},
              "displayLabels": ["gpu", "exported_instance"]
            }
          },
          {
            "id": 4,
            "title": "GPU Power Usage",
            "type": "timeseries",
            "targets": [
              {
                "expr": "DCGM_FI_DEV_POWER_USAGE",
                "legendFormat": "GPU {{gpu}} - {{exported_instance}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 10,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "never",
                  "pointSize": 5,
                  "stacking": {"mode": "none", "group": "A"},
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {"type": "linear"},
                  "axisCenteredZero": false,
                  "hideFrom": {"legend": false, "tooltip": false, "vis": false},
                  "thresholdsStyle": {"mode": "off"}
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null}
                  ]
                },
                "unit": "watt"
              }
            },
            "options": {
              "tooltip": {"mode": "single", "sort": "none"},
              "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["last", "max"]},
              "displayLabels": ["gpu", "exported_instance"]
            }
          },
          {
            "id": 5,
            "title": "Memory Bandwidth Utilization",
            "type": "timeseries",
            "targets": [
              {
                "expr": "DCGM_FI_DEV_MEM_COPY_UTIL",
                "legendFormat": "GPU {{gpu}} - {{exported_instance}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 10,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "never",
                  "pointSize": 5,
                  "stacking": {"mode": "none", "group": "A"},
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {"type": "linear"},
                  "axisCenteredZero": false,
                  "hideFrom": {"legend": false, "tooltip": false, "vis": false},
                  "thresholdsStyle": {"mode": "off"}
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 80},
                    {"color": "red", "value": 95}
                  ]
                },
                "unit": "percent",
                "min": 0,
                "max": 100
              }
            },
            "options": {
              "tooltip": {"mode": "single", "sort": "none"},
              "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["last", "max"]},
              "displayLabels": ["gpu", "exported_instance"]
            }
          }
        ],
        "time": {"from": "now-1h", "to": "now"},
        "timepicker": {},
        "templating": {"list": []},
        "annotations": {"list": []},
        "refresh": "30s",
        "schemaVersion": 36,
        "version": 1,
        "links": []
      }
    }
